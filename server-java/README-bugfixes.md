# 버그 수정 메모

프로젝트 내 주요 버그를 조사한 뒤, 원인과 수정 결과를 정리했습니다.

## 버그 1 – 최초 주문 시 중복(최대 3건) 생성

- **이전 동작:** `OrderService`가 주문을 생성할 때 SQLite 잠금 오류가 나면 재시도하도록 되어 있었지만, 트랜잭션이 적용되지 않아 실패한 시도에서도 주문 레코드가 커밋되었습니다. 이 때문에 첫 주문에서 동일한 주문이 여러 번 저장되었습니다.
- **수정 후:** 주문 생성 로직을 `TransactionTemplate`을 사용한 실제 트랜잭션 안에서 실행하도록 변경했습니다. 잠금 오류가 발생해도 이전 시도는 롤백되며, 성공한 최종 시도만 커밋됩니다. `OrderServiceTransactionIT` 통합 테스트로 회귀를 방지합니다.

## 버그 2 – 관리자 직원/배달 배정 시 스케줄 상태 꼬임

- **이전 동작:** `AdminController`가 배달 스케줄을 수동으로 생성/삭제하면서 중복 체크를 하지 않았고, 스케줄 생성과 주문 업데이트가 분리되어 있어 충돌과 상태 불일치가 발생했습니다.
- **수정 후:** `DeliverySchedulingService.commitAssignmentForOrder`를 통해 모든 스케줄을 일관되게 생성/업데이트하고, 겹치는 배달 시간대가 있으면 예외를 발생시켜 중복 배정이 되지 않도록 했습니다. 직원 타입(조리/배달)에 대한 유효성 검증도 추가했습니다. `DeliverySchedulingServiceTest`로 중복 차단을 검증합니다.

## 버그 3 – 재고 페이지의 “이번 주 예약 현황”이 항상 0

- **이전 동작:** 주간 합계를 `windowStart` 기반으로 계산했는데, 실제 조회에 사용되는 지표는 `deliveryTime`이라 계산 범위가 어긋나 0으로 표시되는 경우가 많았습니다.
- **수정 후:** 주간 합계를 `deliveryTime` 기준으로 다시 계산하도록 변경했고, 단위 테스트 `InventoryServiceWeeklyReservedTest`로 결과가 반영되는지 확인했습니다.

각 버그는 관련 서비스/컨트롤러/레포지토리 코드와 테스트에 반영되어 있으며, 향후 동일 문제가 재발하지 않도록 검증 로직과 로그를 강화했습니다.

